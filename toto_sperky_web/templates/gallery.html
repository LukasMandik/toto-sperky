{% extends 'base.html' %}
{% load static %}
{% block title %}Galllery{% endblock %}

{% block content %}

<div class="gallery_content_page">
    <div class="categories">
        <ul>
            <div class="categories_item">
                <li {% if not selected_category %} class="selected"{% endif %}><a href="/gallery">All</a></li>
            </div>
            {% for category in categories %}
            <div class="categories_item">
                <li {% if category.name == selected_category %} class="selected"{% endif %}><a href="/gallery?category={{ category.name }}">{{ category.name }}</a></li>
            </div>
            {% endfor %}
        </ul>
    </div>
    <div class="line_center" >
        <svg height="100%" stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;" version="1.1" viewBox="0 0 29.7939 613.738" width="100%" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
            <defs/>
            <g id="Layer-1">
            <path d="M15.4714 8.91668L15.3701 605.8" fill="black" fill-rule="nonzero" opacity="1" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="3.1" class="line"/>
            </g>
        </svg>
    </div> 
    <div class="gallery_container">
        <div class="container starter">
            {% for product in products %}
            <div class="box">
                <!-- <a href="{{ product.get_absolute_url }}"> -->
                    <img src="{{ product.image.url }}" alt="{{ product.name }}" class="gallery-image"  data-slug="{{ product.slug }}">
                <!-- </a> -->
            </div> 
            <div class="line_center_short" > 
                <svg height="100%" stroke-miterlimit="10" style="fill-rule:nonzero;clip-rule:evenodd;stroke-linecap:round;stroke-linejoin:round;" version="1.1" viewBox="0 0 29.7939 150" width="100%" xml:space="preserve" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink">
                    <defs/>
                    <g id="Layer-1">
                        <path d="M15.4714 0L15.3701 150" fill="black" fill-rule="nonzero" opacity="1" stroke="black" stroke-linecap="round" stroke-linejoin="round" stroke-width="1.1" class="line"/>
                    </g>
                </svg>
            </div> 
            {% endfor %}


        </div>

    </div>
            <div id="modal" class="modal">
                <div class="modal-content">
                    <span class="close-button">&times;</span>

                    <div class="modal-body">
            
                        <h3 class="modal-name"></h3>
                        <img src="" class="modal-img" alt="">
                        <p class="modal-description"></p>
                        
                    </div>
        
                    <span class="previous-button"><i class='bx bx-chevron-left' ></i></span> 
                    <span class="next-button"><i class='bx bx-chevron-right' ></i></span> 
          

                </div>
            </div>
        

            <!-- <div id="modal" class="modal">
                <span class="close-button">&times;</span>
                <span class="previous-button"><i class='bx bx-chevron-left' ></i></span> 
                <span class="next-button"><i class='bx bx-chevron-right' ></i></span> 
                <div class="modal-content">
     
                </div>
                <div class="modal-body">
        
                </div>
              
            </div> -->
            
        {% if not products %}
        <p>No products found.</p>
        {% endif %}

    </div>

</div>

<script>
  document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    const closeButton = document.querySelector('.close-button');
    const modalImg = document.querySelector('.modal-img');
    const modalName = document.querySelector('.modal-name');
    const modalDescription = document.querySelector('.modal-description');
    const galleryImages = document.querySelectorAll('.container .box img');
    const nextButton = document.querySelector('.next-button');
    const previousButton = document.querySelector('.previous-button');
    
    let currentIndex = -1;
    let originalUrl = window.location.pathname; // Uloží pôvodnú URL pre prípadné vrátenie

    const fetchProductData = (slug) => {
        return fetch(`/product/${slug}/data/`)
            .then(response => response.json())
            .catch(error => console.error('Error fetching product data:', error));
    };

    const showProductInModal = (index, updateHistory = true) => {
        if (index >= 0 && index < galleryImages.length) {
            const slug = galleryImages[index].getAttribute('data-slug');
            fetchProductData(slug)
                .then(data => {
                    modalImg.src = data.image_url;
                    modalName.innerText = data.name;
                    modalDescription.innerText = data.description;
                    
                    document.body.style.overflow = 'hidden'; // Zastaví posúvanie
                    modal.style.display = 'flex'; // Zobrazí modal
                    currentIndex = index; // Nastaví aktuálny index
                    
                    if (updateHistory) {
                        history.pushState({ product: slug }, '', `/product/${slug}/`); // Aktualizuje URL
                    }
                });
        }
    };

    galleryImages.forEach((img, index) => {
        img.addEventListener('click', function () {
            showProductInModal(index);
        });
    });

    // Pridanie podpory pre tlačidlo "Späť"
    window.addEventListener('popstate', function (e) {
        const state = e.state;

        if (state && state.product) { // Ak je produkt v histórii
            const productIndex = Array.from(galleryImages).findIndex(img => img.getAttribute('data-slug') === state.product);

            if (productIndex >= 0) {
                showProductInModal(productIndex, false); // Obnoví modál bez aktualizácie histórie
            }
        } else { 
            // Ak nie je stav s produktom, zatvára modal
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Obnoví posúvanie
        }
    });

    closeButton.addEventListener('click', function () {
        modal.style.display = 'none'; // Zavrie modal
        document.body.style.overflow = 'auto'; // Obnoví posúvanie
        
        // Návrat na pôvodnú URL
        if (window.location.pathname !== originalUrl) {
            history.pushState(null, '', originalUrl); // Vráti na pôvodnú URL
        }
    });

    // Posun na ďalší produkt
    nextButton.addEventListener('click', function () {
        if (currentIndex + 1 < galleryImages.length) {
            showProductInModal(currentIndex + 1);
        }
    });

    // Posun na predchádzajúci produkt
    previousButton.addEventListener('click', function () {
        if (currentIndex - 1 >= 0) {
            showProductInModal(currentIndex - 1);
        }
    });

    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Obnoví posúvanie
            
            // Návrat na pôvodnú URL
            if (window.location.pathname !== originalUrl) {
                history.pushState(null, '', originalUrl); // Vráti na pôvodnú URL
            }
        }
    });
});
    </script>
    

<!-- 
<script>
    document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    const galleryImages = document.querySelectorAll('.container .box img');

    galleryImages.forEach(img => {
        img.addEventListener('click', function () {
            const slug = this.getAttribute('slug'); // predpokladáme, že máte slug ako atribút
            fetch(`/product/${slug}/`) // použite slug na získanie detailov produktu
            .then(response => response.text())
            .then(html => {
                modalContent.innerHTML = html; // Naplnenie modálu obsahom
                modal.style.display = 'flex'; // Zobrazenie modálu
            })
            .catch(error => console.error('Error fetching product details:', error));
        });
    });

    const closeButton = document.querySelector('.close-button');
    closeButton.addEventListener('click', function () {
        modal.style.display = 'none'; // Skrytie modálu
    });

    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            modal.style.display = 'none'; // Skrytie modálu pri kliknutí mimo jeho obsahu
        }
    });
});

</script> -->


<!-- <script>
    document.addEventListener('DOMContentLoaded', function () {
    const modal = document.getElementById('modal');
    const modalContent = document.querySelector('.modal-content');
    const closeButton = document.querySelector('.close-button');
    const galleryImages = document.querySelectorAll('.container .box img');
    
    let currentIndex = -1;

    const showProductInModal = (index) => {
        if (index >= 0 && index < galleryImages.length) {
            const slug = galleryImages[index].getAttribute('slug'); // Získa slug produktu
            const productUrl = `/product/${slug}/`; // URL z slugu

            fetch(productUrl) // Načítanie detailov produktu
                .then(response => {
                    if (!response.ok) {
                        throw new Error(`Request failed with status ${response.status}`);
                    }
                    return response.text();
                })
                .then(html => {
                    modalContent.innerHTML = html; // Zobrazí obsah modálu
                    document.body.style.overflow = 'hidden'; // Zastavte posúvanie
                    modal.style.display = 'flex'; // Zobrazí modal
                    currentIndex = index; // Nastaví aktuálny index
                })
                .catch(error => console.error('Error fetching product details:', error));
        }
    };

    galleryImages.forEach((img, index) => {
        img.addEventListener('click', function (event) {
            event.preventDefault(); // Zabraňuje otvoreniu novej stránky
            showProductInModal(index);
        });
    });

    const nextButton = document.querySelector('.next-button');
    const previousButton = document.querySelector('.previous-button');

    nextButton.addEventListener('click', function () {
        showProductInModal(currentIndex + 1); // Posun na ďalší obrázok
    });

    previousButton.addEventListener('click', function () {
        showProductInModal(currentIndex - 1); // Posun na predchádzajúci obrázok
    });

    closeButton.addEventListener('click', function () {
        modal.style.display = 'none'; // Skrytie modálu
        document.body.style.overflow = 'auto'; // Obnovte posúvanie
    });

    modal.addEventListener('click', function (e) {
        if (e.target === modal) {
            modal.style.display = 'none';
            document.body.style.overflow = 'auto'; // Obnovte posúvanie
        }
    });
});
</script> -->
{% endblock %}